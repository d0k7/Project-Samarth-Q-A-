<!-- app/templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Samarth — Local Q&A prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Google font (optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">PS</div>
        <div class="title">
          <h1>Project Samarth</h1>
          <p>Local agriculture & climate Q&A — prototype</p>
        </div>
      </div>
      <div>
        <button class="btn ghost" id="downloadProv">Download Provenance</button>
      </div>
    </div>

    <div class="grid">
      <main>
        <div class="card">
          <label style="display:block; font-weight:600; margin-bottom:8px">Ask a question</label>
          <div class="query-row">
            <textarea id="question">Compare the average annual climate metric in StateA and StateB for the last 5 years.</textarea>
          </div>
          <div class="controls">
            <button id="askBtn" class="btn primary">Ask</button>
            <button id="listBtn" class="btn small">List states</button>
            <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
              <div id="status" class="kv">Ready</div>
            </div>
          </div>

          <div class="result" id="resultWrap" style="display:none">
            <div class="left">
              <div class="answer-block" id="answerText">—</div>

              <div class="data-grid">
                <div class="data-card">
                  <h4>Climate</h4>
                  <div id="climateTableWrap"></div>
                </div>
                <div class="data-card">
                  <h4>Top Crops</h4>
                  <div id="topCropsWrap"></div>
                </div>
              </div>

              <div class="chart-wrap" id="chartWrap" style="display:none; margin-top:12px">
                <img id="chartImg" alt="chart" style="max-width:100%; border-radius:8px" />
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="display:flex; align-items:center; justify-content:space-between">
            <div>
              <h3 style="margin:0">Provenance</h3>
              <p class="hint">Source files used and useful debug notes.</p>
            </div>
            <div>
              <button id="copyProv" class="copy-btn">Copy</button>
            </div>
          </div>
          <pre id="provJson" class="prov">No provenance yet. Ask a question to populate.</pre>
        </div>

        <div class="footer">Tip: try "List states" or "Analyze trend of Wheat in StateA"</div>
      </main>

      <aside class="side">
        <div class="card">
          <h4 style="margin:0 0 8px 0">Quick Actions</h4>
          <div style="display:flex; gap:8px; flex-direction:column">
            <button class="btn" id="ex1">Compare last 5 years</button>
            <button class="btn" id="ex2">Top 3 crops (last 5 yrs)</button>
            <button class="btn" id="ex3">Analyze wheat trend</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Raw JSON (last response)</h4>
          <div class="prov" id="rawJson">No response yet.</div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* keep UI reactive but simple */
const askBtn = document.getElementById("askBtn");
const listBtn = document.getElementById("listBtn");
const questionEl = document.getElementById("question");
const statusEl = document.getElementById("status");
const answerText = document.getElementById("answerText");
const provJson = document.getElementById("provJson");
const rawJson = document.getElementById("rawJson");
const resultWrap = document.getElementById("resultWrap");
const provCopy = document.getElementById("copyProv");
const downloadProv = document.getElementById("downloadProv");
const chartImg = document.getElementById("chartImg");
const chartWrap = document.getElementById("chartWrap");

let lastResponse = null;

function setStatus(text, busy=false){
  statusEl.textContent = text;
  if(busy){
    statusEl.innerHTML = '<span class="spinner" style="vertical-align:middle;margin-right:8px"></span> '+text;
  }
}

async function doQuery(question){
  setStatus("Thinking...", true);
  try{
    const res = await fetch("/api/query", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({question})
    });
    if(!res.ok){
      const txt = await res.text();
      setStatus("Server error");
      throw new Error(txt || "Server returned non-OK status");
    }
    const j = await res.json();
    setStatus("Done");
    return j;
  }catch(e){
    setStatus("Error");
    throw e;
  }
}

function renderTable(target, rows){
  if(!rows || rows.length === 0){
    target.innerHTML = "<div style='color:#9aa4b2'>No rows</div>";
    return;
  }
  const cols = Object.keys(rows[0]);
  let html = '<table class="data"><thead><tr>';
  for(const c of cols) html += `<th>${c}</th>`;
  html += '</tr></thead><tbody>';
  for(const r of rows){
    html += '<tr>';
    for(const c of cols) html += `<td>${r[c] === null || r[c] === undefined ? "" : r[c]}</td>`;
    html += '</tr>';
  }
  html += '</tbody></table>';
  target.innerHTML = html;
}

function renderTopCrops(target, topObj){
  if(!topObj) { target.innerHTML = "<div style='color:#9aa4b2'>No data</div>"; return; }
  let html = "";
  for(const k of Object.keys(topObj)){
    html += `<div style="margin-bottom:8px"><strong style="display:block;color:var(--muted);font-size:13px">${k}</strong>`;
    const rows = topObj[k];
    if(rows && rows.length){
      html += '<table class="data"><thead><tr><th>crop</th><th>production_tonnes</th></tr></thead><tbody>';
      for(const r of rows) html += `<tr><td>${r.crop || r.Crops || ""}</td><td>${r.production_tonnes ?? r.production ?? ""}</td></tr>`;
      html += '</tbody></table>';
    } else {
      html += "<div style='color:#9aa4b2'>No rows</div>";
    }
    html += "</div>";
  }
  target.innerHTML = html;
}

askBtn.addEventListener("click", async ()=>{
  const q = questionEl.value || "";
  try{
    resultWrap.style.display = "none";
    setStatus("Sending...", true);
    const resp = await doQuery(q);
    lastResponse = resp;
    // render
    answerText.textContent = resp.answer_text || "—";
    if(resp.climate_table && resp.climate_table.length){
      renderTable(document.getElementById("climateTableWrap"), resp.climate_table);
    } else {
      document.getElementById("climateTableWrap").innerHTML = "<div class='kv'>No climate table</div>";
    }
    renderTopCrops(document.getElementById("topCropsWrap"), resp.top_crops);
    provJson.textContent = JSON.stringify(resp.provenance || resp.provenance || [], null, 2);
    rawJson.textContent = JSON.stringify(resp, null, 2);
    // chart
    if(resp.chart){
      chartImg.src = resp.chart;
      chartWrap.style.display = "block";
    } else {
      chartImg.src = "";
      chartWrap.style.display = "none";
    }
    resultWrap.style.display = "block";
    setStatus("Ready");
  }catch(err){
    console.error(err);
    alert("Request failed: " + (err.message || err));
    setStatus("Error");
  }
});

listBtn.addEventListener("click", ()=>{
  questionEl.value = "list states";
  askBtn.click();
});

// quick examples
document.getElementById("ex1").addEventListener("click", ()=>{
  questionEl.value = "Compare the average annual climate metric in StateA and StateB for the last 5 years.";
  askBtn.click();
});
document.getElementById("ex2").addEventListener("click", ()=>{
  questionEl.value = "Top 3 crops in All India for last 5 years";
  askBtn.click();
});
document.getElementById("ex3").addEventListener("click", ()=>{
  questionEl.value = "Analyze trend of Wheat in All India over last 5 years";
  askBtn.click();
});

// copy & download provenance
provCopy.addEventListener("click", ()=>{
  try{
    navigator.clipboard.writeText(provJson.textContent);
    provCopy.textContent = "Copied";
    setTimeout(()=> provCopy.textContent = "Copy", 1200);
  }catch(e){
    alert("Copy failed");
  }
});

downloadProv.addEventListener("click", ()=>{
  if(!lastResponse) return alert("No provenance to download yet.");
  const blob = new Blob([JSON.stringify(lastResponse.provenance || [], null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "provenance.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
